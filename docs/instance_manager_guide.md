# å¯¦ä¾‹ç®¡ç†å·¥å…·ä½¿ç”¨æŒ‡å—

## æ¦‚è¿°

å¯¦ä¾‹ç®¡ç†å·¥å…·æä¾›äº†çµ±ä¸€çš„æ¥å£ä¾†ç®¡ç†å¤šå€‹äº¤æ˜“æ©Ÿå™¨äººå¯¦ä¾‹ï¼ŒåŒ…æ‹¬æŸ¥çœ‹ç‹€æ…‹ã€é©—è­‰é…ç½®ã€æ¸…ç†è¨˜éŒ„ç­‰åŠŸèƒ½ã€‚

## æ ¸å¿ƒçµ„ä»¶

### 1. InstanceRegistry (å¯¦ä¾‹è¨»å†Šè¡¨)

ä½æ–¼ `core/instance_manager.py`ï¼Œæä¾›å¯¦ä¾‹çš„è¨»å†Šã€æŸ¥è©¢å’Œç®¡ç†åŠŸèƒ½ã€‚

**ä¸»è¦æ–¹æ³•ï¼š**
- `register(instance_id, info)` - è¨»å†Šæ–°å¯¦ä¾‹
- `unregister(instance_id)` - è¨»éŠ·å¯¦ä¾‹
- `get(instance_id)` - ç²å–å¯¦ä¾‹ä¿¡æ¯
- `list_instances(include_dead)` - åˆ—å‡ºæ‰€æœ‰å¯¦ä¾‹
- `cleanup_dead_instances()` - æ¸…ç†å·²åœæ­¢çš„å¯¦ä¾‹è¨˜éŒ„

### 2. InstanceManager (å¯¦ä¾‹ç®¡ç†å™¨)

æä¾›æ›´é«˜ç´šçš„ç®¡ç†åŠŸèƒ½ï¼ŒåŒ…æ‹¬çµ±è¨ˆä¿¡æ¯å’Œé…ç½®é©—è­‰ã€‚

**ä¸»è¦æ–¹æ³•ï¼š**
- `get_instance_stats(instance_id)` - ç²å–å¯¦ä¾‹çµ±è¨ˆä¿¡æ¯
- `get_all_stats()` - ç²å–æ‰€æœ‰å¯¦ä¾‹çµ±è¨ˆ
- `validate_instance_config(instance_id)` - é©—è­‰å¯¦ä¾‹é…ç½®

### 3. å‘½ä»¤è¡Œå·¥å…· (CLI)

ä½æ–¼ `cli/instance_cli.py`ï¼Œæä¾›å‹å¥½çš„å‘½ä»¤è¡Œç•Œé¢ã€‚

## å‘½ä»¤è¡Œå·¥å…·ä½¿ç”¨

### åˆ—å‡ºå¯¦ä¾‹

```bash
# åˆ—å‡ºæ‰€æœ‰é‹è¡Œä¸­çš„å¯¦ä¾‹
python cli/instance_cli.py list

# åˆ—å‡ºæ‰€æœ‰å¯¦ä¾‹ï¼ˆåŒ…æ‹¬å·²åœæ­¢çš„ï¼‰
python cli/instance_cli.py list --all
```

**è¼¸å‡ºç¤ºä¾‹ï¼š**
```
============================================================================================================================================
å¯¦ä¾‹ID                 ç‹€æ…‹           PID        Webç«¯å£      é…ç½®æ–‡ä»¶                                     å•Ÿå‹•æ™‚é–“
============================================================================================================================================
bp_eth_02            ğŸŸ¢ é‹è¡Œä¸­        12346      5002       config/active/bp_eth_02.json             2025-11-28 22:05:00
bp_sol_01            ğŸŸ¢ é‹è¡Œä¸­        12345      5001       config/active/bp_sol_01.json             2025-11-28 22:00:00
============================================================================================================================================

ç¸½è¨ˆ: 2 å€‹é‹è¡Œä¸­çš„å¯¦ä¾‹
```

### é¡¯ç¤ºçµ±è¨ˆä¿¡æ¯

```bash
# é¡¯ç¤ºæ‰€æœ‰å¯¦ä¾‹çš„çµ±è¨ˆä¿¡æ¯
python cli/instance_cli.py stats

# é¡¯ç¤ºç‰¹å®šå¯¦ä¾‹çš„çµ±è¨ˆä¿¡æ¯
python cli/instance_cli.py stats --instance-id bp_sol_01
```

**ç‰¹å®šå¯¦ä¾‹çµ±è¨ˆè¼¸å‡ºç¤ºä¾‹ï¼š**
```
================================================================================
å¯¦ä¾‹çµ±è¨ˆ: bp_sol_01
================================================================================
ç‹€æ…‹:       ğŸŸ¢ é‹è¡Œä¸­
PID:        12345
Webç«¯å£:    5001
é…ç½®æ–‡ä»¶:   config/active/bp_sol_01.json
æ—¥èªŒç›®éŒ„:   logs/bp_sol_01
å•Ÿå‹•æ™‚é–“:   2025-11-28 22:00:00

é€²ç¨‹ä¿¡æ¯:
  é€²ç¨‹å:   python3
  ç‹€æ…‹:     running
  CPU:      2.5%
  å…§å­˜:     145.3 MB
  ç·šç¨‹æ•¸:   8
  å‰µå»ºæ™‚é–“: 2025-11-28 22:00:15
================================================================================
```

### é¡¯ç¤ºå¯¦ä¾‹è©³ç´°ä¿¡æ¯

```bash
# é¡¯ç¤ºå¯¦ä¾‹çš„æ‰€æœ‰å­—æ®µä¿¡æ¯
python cli/instance_cli.py info bp_sol_01
```

**è¼¸å‡ºç¤ºä¾‹ï¼š**
```
================================================================================
å¯¦ä¾‹ä¿¡æ¯: bp_sol_01
================================================================================

config_file         : config/active/bp_sol_01.json
last_updated        : 2025-11-28 22:00:00
log_dir             : logs/bp_sol_01
pid                 : 12345
registered_at       : 2025-11-28 22:00:00
started_at          : 2025-11-28 22:00:00
status              : running
web_port            : 5001

================================================================================
```

### é©—è­‰å¯¦ä¾‹é…ç½®

```bash
# é©—è­‰æ‰€æœ‰å¯¦ä¾‹çš„é…ç½®
python cli/instance_cli.py validate

# é©—è­‰ç‰¹å®šå¯¦ä¾‹çš„é…ç½®
python cli/instance_cli.py validate --instance-id bp_sol_01

# é¡¯ç¤ºè©³ç´°çš„é©—è­‰ä¿¡æ¯ï¼ˆåŒ…æ‹¬è­¦å‘Šï¼‰
python cli/instance_cli.py validate --verbose
```

**è¼¸å‡ºç¤ºä¾‹ï¼š**
```
================================================================================
é©—è­‰æ‰€æœ‰å¯¦ä¾‹é…ç½®
================================================================================

âœ… bp_eth_02
âœ… bp_sol_01

================================================================================
ç¸½è¨ˆ: 2 å€‹å¯¦ä¾‹ (æœ‰æ•ˆ: 2, ç„¡æ•ˆ: 0)
================================================================================
```

### æ¸…ç†å·²åœæ­¢çš„å¯¦ä¾‹

```bash
# æ¸…ç†å·²åœæ­¢çš„å¯¦ä¾‹è¨˜éŒ„ï¼ˆæœƒè©¢å•ç¢ºèªï¼‰
python cli/instance_cli.py cleanup

# å¼·åˆ¶æ¸…ç†ï¼Œä¸è©¢å•ç¢ºèª
python cli/instance_cli.py cleanup --force
```

**è¼¸å‡ºç¤ºä¾‹ï¼š**
```
ç™¼ç¾ 2 å€‹å·²åœæ­¢çš„å¯¦ä¾‹:
  - bp_eth_02 (PID: 12346)
  - bp_sol_01 (PID: 12345)

ç¢ºèªæ¸…ç†é€™äº›å¯¦ä¾‹è¨˜éŒ„? (y/N): y

âœ… å·²æ¸…ç† 2 å€‹å·²åœæ­¢çš„å¯¦ä¾‹è¨˜éŒ„
```

## Python API ä½¿ç”¨

### åŸºæœ¬ä½¿ç”¨ç¤ºä¾‹

```python
from core.instance_manager import InstanceRegistry, InstanceManager

# å‰µå»ºè¨»å†Šè¡¨
registry = InstanceRegistry()

# è¨»å†Šå¯¦ä¾‹
registry.register("my_instance", {
    "config_file": "config/my_instance.json",
    "pid": 12345,
    "log_dir": "logs/my_instance",
    "web_port": 5001,
    "started_at": "2025-11-28T22:00:00"
})

# ç²å–å¯¦ä¾‹ä¿¡æ¯
info = registry.get("my_instance")
print(f"Web Port: {info['web_port']}")

# åˆ—å‡ºæ‰€æœ‰å¯¦ä¾‹
instances = registry.list_instances()
for inst in instances:
    print(f"{inst['instance_id']}: {inst['is_alive']}")

# æŒ‰ç«¯å£æŸ¥æ‰¾å¯¦ä¾‹
inst = registry.get_instance_by_port(5001)
print(f"Found: {inst['instance_id']}")

# è¨»éŠ·å¯¦ä¾‹
registry.unregister("my_instance")
```

### ä½¿ç”¨ InstanceManager

```python
from core.instance_manager import InstanceManager

# å‰µå»ºç®¡ç†å™¨
manager = InstanceManager()

# ç²å–å¯¦ä¾‹çµ±è¨ˆ
stats = manager.get_instance_stats("my_instance")
if stats:
    print(f"CPU: {stats['process_info']['cpu_percent']}%")
    print(f"Memory: {stats['process_info']['memory_mb']} MB")

# é©—è­‰é…ç½®
result = manager.validate_instance_config("my_instance")
if result['valid']:
    print("é…ç½®æœ‰æ•ˆ")
else:
    print(f"éŒ¯èª¤: {result['errors']}")

# ç²å–æ‰€æœ‰çµ±è¨ˆ
all_stats = manager.get_all_stats()
for stats in all_stats:
    print(f"{stats['instance_id']}: {'é‹è¡Œä¸­' if stats['is_alive'] else 'å·²åœæ­¢'}")
```

## åœ¨ Daemon Manager ä¸­çš„é›†æˆ

Daemon Manager å·²ç¶“è‡ªå‹•é›†æˆäº†å¯¦ä¾‹è¨»å†ŠåŠŸèƒ½ï¼š

```python
from core.daemon_manager import TradingBotDaemon

# å‰µå»ºå®ˆè­·é€²ç¨‹ï¼ˆæœƒè‡ªå‹•è¨»å†Šï¼‰
daemon = TradingBotDaemon("config/my_instance.json")

# å•Ÿå‹•ï¼ˆè¨»å†Šä¿¡æ¯æœƒè‡ªå‹•æ›´æ–°ï¼‰
daemon.start(daemonize=True)

# åœæ­¢ï¼ˆæœƒè‡ªå‹•è¨»éŠ·ï¼‰
daemon.stop()
```

## è¨»å†Šè¡¨æ–‡ä»¶æ ¼å¼

è¨»å†Šè¡¨å­˜å„²åœ¨ `logs/instances.json`ï¼š

```json
{
  "bp_sol_01": {
    "config_file": "config/active/bp_sol_01.json",
    "pid": 12345,
    "log_dir": "logs/bp_sol_01",
    "web_port": 5001,
    "started_at": "2025-11-28T22:00:00",
    "registered_at": "2025-11-28T22:00:05",
    "last_updated": "2025-11-28T22:00:05",
    "status": "running"
  }
}
```

## æœ€ä½³å¯¦è¸

1. **å®šæœŸæ¸…ç†**: ä½¿ç”¨ `cleanup` å‘½ä»¤æ¸…ç†å·²åœæ­¢çš„å¯¦ä¾‹è¨˜éŒ„
2. **ç›£æ§ç‹€æ…‹**: å®šæœŸé‹è¡Œ `stats` å‘½ä»¤æª¢æŸ¥å¯¦ä¾‹å¥åº·ç‹€æ…‹
3. **é©—è­‰é…ç½®**: åœ¨å•Ÿå‹•æ–°å¯¦ä¾‹å‰ä½¿ç”¨ `validate` å‘½ä»¤æª¢æŸ¥é…ç½®
4. **æŸ¥çœ‹è©³æƒ…**: ä½¿ç”¨ `info` å‘½ä»¤ç²å–å¯¦ä¾‹çš„å®Œæ•´ä¿¡æ¯
5. **ä¿ç•™è¨˜éŒ„**: ä¸è¦æ‰‹å‹•ç·¨è¼¯ `logs/instances.json`ï¼Œä½¿ç”¨ API æˆ– CLI å·¥å…·

## æ•…éšœæ’é™¤

### å•é¡Œï¼šå¯¦ä¾‹æœªé¡¯ç¤ºåœ¨åˆ—è¡¨ä¸­

**è§£æ±ºæ–¹æ¡ˆï¼š**
1. ä½¿ç”¨ `list --all` æŸ¥çœ‹æ‰€æœ‰å¯¦ä¾‹ï¼ˆåŒ…æ‹¬å·²åœæ­¢çš„ï¼‰
2. æª¢æŸ¥é€²ç¨‹æ˜¯å¦çœŸçš„åœ¨é‹è¡Œï¼š`ps aux | grep run.py`
3. æŸ¥çœ‹è¨»å†Šè¡¨æ–‡ä»¶ï¼š`cat logs/instances.json`

### å•é¡Œï¼šæ¸…ç†å‘½ä»¤ç„¡æ³•åˆªé™¤å¯¦ä¾‹

**è§£æ±ºæ–¹æ¡ˆï¼š**
1. ç¢ºèªå¯¦ä¾‹ç¢ºå¯¦å·²åœæ­¢
2. ä½¿ç”¨ `--force` åƒæ•¸å¼·åˆ¶æ¸…ç†
3. æª¢æŸ¥æ–‡ä»¶æ¬Šé™ï¼š`ls -l logs/instances.json`

### å•é¡Œï¼šçµ±è¨ˆä¿¡æ¯é¡¯ç¤º N/A

**è§£æ±ºæ–¹æ¡ˆï¼š**
1. ç¢ºèªé€²ç¨‹æ­£åœ¨é‹è¡Œ
2. æª¢æŸ¥ PID æ˜¯å¦æ­£ç¢ºï¼š`ps -p <PID>`
3. ç¢ºèªæœ‰æ¬Šé™è¨ªå•é€²ç¨‹ä¿¡æ¯

## ç›¸é—œæ–‡æª”

- [å¤šå¯¦ä¾‹å¯¦æ–½æŒ‡å—](../Cursor_docs/.context/sessions/multi_instance_implementation_guide.md)
- [Daemon Manager æ–‡æª”](../Fork_README.md)
- [é…ç½®ç®¡ç†æ–‡æª”](./config_manager_guide.md)
