# Perp Market Maker 錯誤分析 - 2025-11-28

## 問題概述
系統從 2025-11-28 02:22:57 開始出現 "Order would immediately match and take" 錯誤，導致策略無法正常執行。

## 錯誤分析

### 1. 錯誤日誌內容
```
2025-11-28 16:42:08 - perp_market_maker - ERROR - 永續合約訂單失敗: 狀態碼: 400, 消息: {"code":"INVALID_ORDER","message":"Order would immediately match and take"}, 訂單信息：{'orderType': 'Limit', 'quantity': '0.0521', 'side': 'Ask', 'symbol': 'ETH_USDC_PERP', 'reduceOnly': False, 'timeInForce': 'GTC', 'price': '2871.36', 'postOnly': True}
```

### 2. 根本原因
- 系統嘗試下單時設置了 `postOnly=True`，但計算出的價格過於接近市場價格
- 當 postOnly 訂單的價格會立即匹配時，Backpack 交易所返回 400 錯誤
- 錯誤在一天內重複了數百次，價格範圍從 2871.36 到 3019.19

### 3. 策略配置不匹配問題
- 配置文件 (`config/active/backpack_eth_usdc_perp_grid.json` 和 `config/daemon_config.json`) 都指定了 `perp_grid` 策略
- 但錯誤日誌顯示實際運行的是 `perp_market_maker` 策略
- 這表明系統實際運行的策略與配置不符

## 為什麼之前沒有出現這個問題

### 初始分析（已修正）
最初認為是策略配置變更導致，但經過比較發現：
- 兩個配置文件都指定了相同的策略類型（perp_grid）
- 雖然有一些參數差異，但策略類型是一致的

### 更可能的原因
1. **系統啟動參數問題**：系統可能在 11 月 28 日凌晨通過命令行參數啟動了 perp_market_maker 策略，而不是使用配置文件
2. **代碼邏輯錯誤**：可能存在代碼中的邏輯錯誤，導致在某些條件下系統錯誤地加載了 perp_market_maker
3. **市場條件觸發的特定錯誤**：11 月 28 日凌晨的市場條件（高波動性、價格快速變化）可能觸發了特定錯誤

## 關鍵發現

1. **時間點**：問題首次出現在 11 月 28 日 02:22:57，這表明是在某次系統變更後開始的
2. **策略不匹配**：配置文件顯示應該運行網格策略，但錯誤日誌顯示實際運行的是市場做市策略
3. **重複模式**：錯誤在一天內重複了數百次，說明是持續性問題而非一次性故障
4. **價格範圍**：錯誤訂單的價格從 2871.36 到 3019.19，覆蓋了相當大的價格範圍

## 解決方案建議

1. **立即修復**：
   - 檢查系統實際運行的策略類型
   - 確認是否正確使用了配置文件中的策略設置
   - 修復 perp_market_maker 策略中的價格計算邏輯

2. **長期解決方案**：
   - 添加策略類型驗證，確保運行的策略與配置一致
   - 改進價格計算邏輯，確保 postOnly 訂單不會立即匹配
   - 增強錯誤處理機制，當出現此類錯誤時自動調整訂單參數

## 待調查問題

1. 為什麼系統實際運行的是 perp_market_maker 而不是配置的 perp_grid？
2. 11 月 28 日凌晨發生了什麼變化導致這個問題開始出現？
3. 是否有手動啟動錯誤策略的記錄？

## 配置文件比較

| 參數 | backpack_eth_usdc_perp_grid.json | daemon_config.json | 差異 |
|------|----------------------------------|-------------------|------|
| strategy | perp_grid | perp_grid | 一致 |
| symbol | ETH_USDC_PERP | ETH_USDC_PERP | 一致 |
| grid_lower_price | 2875 | 2750 | 輕微差異 |
| grid_upper_price | 3350 | 3300 | 輕微差異 |
| grid_num | 48 | 50 | 輕微差異 |
| max_position | 3.0 | 2.4 | 輕微差異 |
| stop_loss | 250 | 600 | 較大差異 |
| take_profit | 500 | 1200 | 較大差異 |

## 結論

這個問題很可能是由於 11 月 28 日凌晨的系統配置變更或啟動錯誤引起的，導致系統運行了錯誤的策略類型。需要進一步調查系統啟動日誌和配置加載過程，確定根本原因。