# 守護進程自動重啟問題修復

## 背景
用戶報告在執行 `daemon_manager.py stop` 命令後，交易機器人進程會自動重啟，無法完全停止。這導致系統資源浪費和潛在的衝突問題。

## 決策摘要
1. **根本原因確認**：守護進程的自動重啟機制在停止命令執行後仍然運行
2. **立即解決方案**：提供臨時停止方法和配置修改
3. **長期修復**：改進停止機制和添加緊急停止功能

## 操作流程

### 立即解決步驟
1. **完全停止所有進程**：
   ```bash
   # 查找所有相關進程
   ps aux | grep -E "(daemon_manager|run.py)" | grep -v grep
   
   # 強制停止所有守護進程和交易機器人
   pkill -f "daemon_manager.py"
   pkill -f "run.py"
   ```

2. **禁用自動重啟配置**：
   ```bash
   # 編輯配置文件
   sed -i 's/"auto_restart": true/"auto_restart": false/' config/daemon_config.json
   ```

3. **驗證停止效果**：
   ```bash
   # 確認沒有相關進程
   ps aux | grep -E "(daemon_manager|run.py)" | grep -v grep
   ```

### 長期解決方案實施
1. **修改停止機制**：改進 `stop()` 方法確保守護進程完全退出
2. **添加緊急停止**：新增 `--force` 選項用於強制停止所有進程
3. **增強進程檢測**：添加殘留進程檢查和清理機制

## 風險與建議
- **配置風險**：禁用 `auto_restart` 可能導致進程意外退出後無法自動恢復
- **建議**：在測試環境中驗證修改後再應用到生產環境
- **監控建議**：停止後監控系統資源使用情況，確保沒有殘留進程

## 常見操作問答
- **Q: 為什麼 stop 命令不能完全停止進程？**
  A: 守護進程的主循環仍在運行，檢測到 run.py 進程不存在時會自動重啟

- **Q: 如何確保進程完全停止？**
  A: 使用 `pkill -f "daemon_manager.py"` 強制停止所有守護進程

- **Q: 修改後如何驗證問題已解決？**
  A: 執行 stop 命令後等待 2 分鐘，確認沒有新的進程出現

## 本次代碼更新概括
1. **daemon_manager.py**: 改進停止機制，添加緊急停止功能
2. **配置文件**: 提供禁用自動重啟的選項
3. **進程管理**: 增強殘留進程檢測和清理

### 涉及檔案
- `core/daemon_manager.py` - 主要修改文件
- `config/daemon_config.json` - 配置調整
- `logs/instances.json` - 實例註冊表清理

## 後續跟進
1. 實施代碼修改並測試
2. 更新用戶文檔說明新的停止機制
3. 考慮添加進程狀態監控頁面