# 修复永续合约网格策略对称性问题

## 背景
在代码审查报告 `2025-11-29_perp_grid_fix_code_review.md` 中，审查者指出 `_place_close_short_order` 方法缺少 `_place_close_long_order` 中的关键保护机制，存在**对称性缺失 (Symmetry)** 问题。这会导致平空單比平多單更容易失败，特别是在市场波动剧烈时。

## 决策摘要
1. **添加初始持仓检查**
   - 在平空單逻辑开头添加持仓验证：`net_position > -quantity * 0.9`
   - 确保有足够的空头持仓才尝试平仓，避免不必要的API调用

2. **添加价格缓冲检查**
   - 添加价格合理性验证：`next_price >= current_price * 0.999`
   - 防止平仓价格过于接近市场价格而导致 "immediately match" 错误
   - 注意平空單是买入操作，所以检查方向与平多單相反

3. **完善智能重试机制**
   - 实现 `max_retries = 2` 的循环重试机制
   - 针对 "immediately match" 错误进行智能价格调整（降低 0.05%）
   - 针对 "Reduce only" 错误自动切换为非 reduce_only 模式
   - 添加适当的延迟避免高频请求

## 操作流程
本次修复无需改变配置或操作流程，属于内部逻辑优化：
1. 策略在运行时会自动使用新的对称性平空單逻辑
2. 当开空單成交后，会自动调用修复后的 `_place_close_short_order`
3. 新的保护机制会自动处理边界情况，减少人工干预

## 风险与建议
- **低风险**：修改仅局限于 `_place_close_short_order` 方法内部，不影响其他策略逻辑
- **性能影响**：新增的检查会增加少量计算开销，但避免了不必要的API调用，整体性能更优
- **建议监控**：部署后建议监控平空單的成功率，确认 "immediately match" 错误是否减少

## 常见操作问答
**Q: 这次修复会影响现有持仓吗？**
A: 不会，修复只影响新下的平空單逻辑，现有持仓和订单不受影响。

**Q: 需要修改配置文件吗？**
A: 不需要，所有参数都是硬编码在逻辑中（与平多單保持一致），未来可考虑提取为配置参数。

**Q: 如何验证修复效果？**
A: 观察日志中平空單的失败率，特别是 "immediately match" 和 "Reduce only" 错误的频率应该显著降低。

## 本次代码更新概括
1. **[策略层] `strategies/perp_grid_strategy.py`**:
   - 重构 `_place_close_short_order` 方法（行 1429-1520）
   - 添加初始持仓验证逻辑
   - 添加价格缓冲检查机制
   - 实现智能重试循环，支持价格自动调整
   - 优化日志输出，与平多單保持一致性

### 涉及文件
- `strategies/perp_grid_strategy.py`（主要修改）